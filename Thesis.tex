\documentclass[a4paper, oneside]{discothesis}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{float}
\usepackage{cprotect}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{dirtree}
\usepackage{mathtools}
\usepackage{comment}
\usepackage[labelfont=bf,font=small,skip=5pt]{caption}
\usepackage[outdir=./figures/]{epstopdf}
\usepackage{hyperref}


\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}


\lstdefinestyle{mystyle}{
	backgroundcolor=\color{backcolour},   
	commentstyle=\color{codegreen},
	keywordstyle=\color{magenta},
	numberstyle=\tiny\color{codegray},
	stringstyle=\color{codepurple},
	basicstyle=\ttfamily\footnotesize,
	breakatwhitespace=false,         
	breaklines=true,                 
	captionpos=b,                    
	keepspaces=true,                 
	numbers=left,                    
	numbersep=5pt,                  
	showspaces=false,                
	showstringspaces=false,
	showtabs=false,                  
	tabsize=2
}
\lstset{style=mystyle}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DOCUMENT METADATA

\thesistype{Master's thesis} % Master's thesis, Bachelor's thesis, Semester thesis, Group Project
\title{On fast simulations of cardiac function}

\author{Diego Renner}
\email{drenner@student.ethz.ch}

\institute{Dep. of Mathematics \\[2pt]
ETH ZÃ¼rich}

% Optionally, you can put in your own logo here

\supervisors{Prof. Dr. Siddhartha Mishra}

% Optionally, keywords and categories of the work can be shown (on the Abstract page)
%\keywords{Keywords go here.}
%\categories{ACM categories go here.}

\date{\today}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\frontmatter % do not remove this line
\maketitle
\cleardoublepage

\begin{acknowledgements}
	
\end{acknowledgements}


\begin{abstract}
	
\end{abstract}

\tableofcontents

\mainmatter % do not remove this line

% Start writing here
\chapter{Introduction}
Among other factors the high number of vessels, the stark differences between these vessels and the resulting different types of flow within them leads to cardiovascular systems being very complex to model.
Therefore in order to better understand cardiovascular function, numerical methods are often applied.
Due to the nature of cardiovascular system numerical methods are especially helpful since they are able to simulate processes that are hard to capture in-vivo.
This also curtails risks to patients and costs that other methods of research might bring along.
Even with numerical methods the and complexity of the cardiovascular system still poses a significant challenge.
This leads to one-dimensional (1D) models often being chosen over three-dimensional (3D) models. 
1D models do have a lower accuracy, especially at junctions within the system.
Nevertheless the accuracy has been shown to be suficient to simulate haemodynamics in large vascular systems.
While the increas in simulatino speed gained by choosing 1D models over 3D models is significant an efficient implementation of the solver is still important.
Next to speed desired attributes of a simulation are differentiability with respect to the model parameters, maintainability of code base, and ease of use.
Differentiability leads to a model being easily optimized if appropriate data sets are provided while maintainability and ease of use lower the barrier of entry for future work being supported by the written code as well as the code being applied readily by others.
For the reasons mentioned in this introduction the goal of this thesis is to provide a fast differentiable 1D cardiovascular simulation code.
This goal is pursued by using a 1D reduction of the 3D Navier Stokes Equations (NSE) implemented numerically using the JAX library in Python.
In the next section we will provide a basic understanding of the cardiovascular system which will serve as a base for describing the cardiovascular simulation throughout this work.




\chapter{Cardiovascular System}
This section serves as an overview of the cardiovascular system with a focus on the arteries of the systemic circulation. 
Section \ref{mbb} will describe the main building blocks of the cardiovascular system and their relation, section \ref{aw} will give the characteristics of the arterial walls, and section \ref{b} the characteristics of blood.
\section{Main Building Blocks} \label{mbb}
The cardiovascular system contains two major circulations.
These are the systemic and the pulmonary circulation. 
Both are fed with blood pumped from the heart.
Through the systemic circulation organs are supplied with oxygen-rich blood which is then transported back to the heart where it then enters the pulmonary circulation.
Through the pulmonary circulation the oxygen-poor blood is sent to the lungs where it is replenished with oxygen and then returned to the heart to reenter the systemic circulation.
Vessels carrying the blood away from the heart are referred to as arteries and the ones carrying the blood to the heart are referred to as veins.
In both the systemic and the pulmonary circulation the oxygen exchange (from blood to organs or from lungs to blood respectively) take place within so called capillary vessels.
Capillaries are very small vessels that connect arteries to veins.
From here on out our main focus will be on on the arteries of the systemic circulation. 
In the next two subsections we will describe the main characteristics of the arterial walls and the blood flowing within respectively.

\section{Arterial Wall} \label{aw}
An arterial wall consists of three layers or tunicae: an inner, middle, and outer layer also referred to as intima, media, and adventita respectively.
The tunica intima lines the inside of the artery. It is made up of a single layer of endothelial cells encased in a thin layer of elastin and collagen fibres (connective tissue). 
On the outside of the artery the tunica adventita is made up of connective tissue as well which attaches the artery to surounding connective tissue.
Inbetween these two layers lies the thickest layer, the tunica media, which consists of elastic fibres and muscle cells. 
The tunica media is responsible for the elasticity of the artery.
Arteries close to the heart have a tunica media that is mainly made up of elastic fibres and are referred to as elastic arteries while the tunica media of arteries farther away from the heart and of small arteries consist predominently of muscle cells and are called muscular arteris.
On the topic of elasticity or elastance, the tendency of a hollow organ to recoil toward its original dimensions upon removal of a distending or compressing force, we also have compliance, the ability of a hollow organ (vessel) to distend and increase volume with increasing transmural pressure or the tendency of a hollow organ to resist recoil toward its original dimensions on application of a distending or compressing force.
The elastic arteries have a higher compliance and will deform more under pressure than the muscular arteries that are stiffer.
At the same time usually the elastic arteries are larger than the muscular arteries since the size of arteries generally descends as the distnce to the heart increases.
The compliance of these larger elastic arteries is responsible for transforming the pulsatile flow at the heart into a constant flow at the capillaries.
The pulse-like pressure change coming from the heart leads to the elastic arteries close to the heart expanding.
Until the next pulse arrives these vessels will contract again, pushing the blood at a constant rate into the arteries farther away from the heart and finally into the capillaries.
This mechanism is called the Windkessel effect.
It is named after the inner workings of waterpumps used by early fire brigades.
In these devices water would be pumped by hand from the reservoir causing pressure pulses.
This would push water into an air chamber.
Here the air would get compressed which is analogous to the deforming of the artery.
The natural decompressing of the air would then push thhe water out through the hose in a steady manner, just like the contracting of the artery would push out the blood.
We call the radius of an artery in it's undeformed state the lumen radius $R_0$.

\section{Blood} \label{b}

Blood consists of red blood cells (Erythocytes), white blood cells (Leukocytes), and platelets (Thrombocytes).
The Erythocytes make up about 97\% of the cellular volume.
They are flexible, can bind to oneanother, and their micro-structure determines the blood mechanical properties.
The volume occupied by red blood cells in respect to the total blood volume is called the haematocrit value.
At different age, altitude, health, and bodily activity the haematocrit value varies.
The blood dynamic viscosity $\mu$ decreases hyperbolically with the shear rate $\gamma$.
At about $\gamma > 100s^{-1}$ the viscosity stays constant for common haematocrit values.
In larger arteries the average shear rate close to the walls is above this threshold.
Therefore the blood's viscosity is constant and it can roughly be considered a Newtonian fluid.
Blood density $\rho$ is constant within the range of $1050 \pm 10 \text{ kg}\cdot\text{m}^{-3}$.


\chapter{1D-Model} \label{chap:1dm}
In this chapter we are going to describe a 1D-model of blood flow, specifically of blood flow in the arteries of the systemic circulation.
First we will describe the 1D-model for a single artery and then we will describe how to string together such models to simulate larger systems of arteries.

\section{Single Vessel} \label{sec:sv}
Within a single vessel we consider the blood flow fully determined by the 3D-Navier-Stokes equations.
These stem from the conservation of mass and momentum 

\begin{align}
	\frac{\partial \rho}{\partial t} + \nabla \cdot \rho \mathbf{v} &= 0 \\
	\frac{\partial \mathbf{v}}{\partial t} + \left( \mathbf{v} \cdot \nabla \right) \mathbf{v} &= - \frac{1}{\rho} \nabla P + \frac{\mu}{\rho} \nabla \mathbf{v} + \mathbf{F}
\end{align}

where in our case $\rho$ and $\mu$ are the blood density and viscosity mentioned in section \ref{b}, $\mathbf{v} = \left[ v_z, v_r, v_\phi \right]$ is the velocity field, $P$ is the pressure, and $\mathbf{F}$ is any force acting on the fluid system.
We consider a vessel to be an axisymmetric tube along the $z$ axis in a cylindrical coordinate system $\left(z,r,\phi\right)$.
Under the following assumptions the 3D-Navier-Stokes equations can be reduced to a 1D-model:

\begin{enumerate}
	\item vessels are narrow, long, and circular
	\item vessels are straight and have linearly elastic compliant walls
	\item vessel walls can be displaced slightly in radial direction but not in longitudinal direction
	\item blood is an incompressible Newtonian fluid.
\end{enumerate}

The 1D equations under these assumptions read:

\begin{equation}
		\begin{aligned} 
			\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial z} &= 0, \\ 
			\frac{\partial Q}{\partial t} + \frac{\partial}{\partial z}\left(\alpha \frac{Q^2}{A} \right) + \frac{A}{\rho} \frac{\partial P}{\partial z} &= -2 \frac{\mu}{\rho} \left( \gamma_\nu + 2 \right) \frac{Q}{A}
		\end{aligned} \label{1Deqs1}
\end{equation}

where $A$ and $Q$ are the cross-sectional area and the volumetric flow rate.
$\alpha$ and $\gamma_\nu$ are the Coriolis' coefficient and the radial velocity profile parameter.
The pressure $P$ is given by the external pressure stemming from surrounding tissue as well as the deformation of the vessel:

\begin{equation}
	P = P_{ext} + \beta \left( \sqrt{\frac{A}{A_0}} - 1 \right), \  \beta = \sqrt{\frac{\pi}{A_0}} \frac{E h_0}{1-\nu^2}
\end{equation}
 where $E$, $h_0$, and $\nu$ are the vessel wall Young's modulus, the reference wall thickness, and the Poisson ratio.
Setting $\alpha = 1$ and $\gamma_\nu = 9$ we can approximate a plug-flow profile.
Inserting this into equation \ref{1Deqs1} leads to 
\begin{equation}
		\begin{aligned} 
			\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial z} &= 0, \\ 
			\frac{\partial Q}{\partial t} + \frac{\partial}{\partial z}\left(\frac{Q^2}{A} \right) + \frac{A}{\rho} \frac{\partial P}{\partial z} &= -22 \frac{\mu}{\rho} \frac{Q}{A}.
		\end{aligned} \label{1Deqs2}
\end{equation}

We can rewrite equation \ref{1Deqs2} in it's conservative form by defining the following shorthands:

\begin{equation}
	\mathbf{U} := 
	\left[ 
		\begin{aligned}
			A \\
			Au
		\end{aligned}
	\right]
\end{equation}

\begin{equation}
	\mathbf{F} \left( \mathbf{U} \right) := 
	\left[ 
		\begin{aligned}
			Au \\
			Au^2 + \gamma A^{3/2}
		\end{aligned}
	\right]
\end{equation}

\begin{equation}
	\mathbf{S} \left( \mathbf{U} \right) := 
	\left[ 
		\begin{aligned}
			0 \\
			f
		\end{aligned}
	\right]
\end{equation}

\begin{equation}
	\gamma := \frac{\beta}{3\rho\sqrt{A_0}}
\end{equation}

\begin{equation}
	f := -\frac{1}{\rho} \left( \frac{\partial P}{\partial A_0} \frac{\partial A_0}{\partial z} + \frac{\partial P}{\partial \beta} \frac{\partial \beta}{\partial z} + 22\mu\frac{u}{A} \right)
\end{equation}.

The conservative form then reads:
\begin{equation}
	\begin{aligned}
		\frac{\partial \mathbf{U}}{\partial t} + \frac{\partial \mathbf{F} \left( \mathbf{U} \right)}{\partial z} &= \mathbf{S} \left( \mathbf{U} \right), \ t>0, \ z \in \left[ 0,l \right] \\
		\mathbf{U} \left( z,0 \right) &= \mathbf{U}_0 \left( z \right), \ z \in \left[ 0,l \right] \\
		\mathbf{U} \left( 0,t \right) &= U_L \left( t \right), \ t>0\\
		\mathbf{U} \left( l,t \right) &= U_R \left( t \right), \ t>0
	\end{aligned} \label{eq:1deqs3}
\end{equation}

where we have added initial and boundary conditions so that equation \ref{eq:1deqs3} now yields a well posed problem.
This concludes the desription if the 1D-model for a single artery.
In the next section we will describe how to connect such models in order to describe larger systems of arteries.


\section{Initial Conditions and Boundary Values}
\subsection{Initial Conditions}
\subsection{Boundary Values}
\subsubsection{Inlets}
The inlet boundary conditions are set from data (either through P or Q) and then the ambiguities in the remaining quantities are determined through extrapolations of characteristics.
First off the Riemann invariants need to be computed at the first and second point of the space discretization for the current time step.
At the first point the two Riemann invariants read as
\begin{align}
	W_{1,0}^n &= u^n_0 - 4c^n_0\\
	W_{2,0}^n &= u^n_0 + 4c^n_0.
\end{align}

At the second point they are denoted by
\begin{align}
	W_{1,0}^n &= u^n_1 - 4c^n_1\\
	W_{2,0}^n &= u^n_1 - 4c^n_1.
\end{align}

We used $c_i^n$ as shorthand for

\begin{equation}
	c^n_i = \sqrt{\frac{3}{2}\gamma\sqrt{A^n_i}}.
\end{equation}

If Q is given the Riemann invariants at the next time step are computed via the following update formula:

\begin{align}
	W_{1,0}^{n+1} &= W^n_{1,0} + (W^n_{1,1} - W^n_{1,0})(c^n_0-u^n_0) \frac{\Delta t}{\Delta x} \label{update1a}\\
	W_{2,0}^{n+1} &= \frac{2Q^{n+1}_0}{A^n_0} - W^{n+1}_{1,0} \label{update2a}
\end{align}
where $Q^{n+1}_0$ is given through input data.
The time step size is defined as described in section \ref{CFL},
The space step size is defined by $\Delta x \coloneqq \frac{L}{M}$.
The missing input quantities are then computed from the new Riemann invariants as follows:

\begin{align}
	u_0^{n+1} &= \frac{W_{1,0}^{n+1} + W_{2,0}^{n+1}}{2} \\
	c_0^{n+1} &= \frac{W_{2,0}^{n+1} - W_{1,0}^{n+1}}{4} \\
	A_0^{n+1} &= \frac{Q_0^{n+1}}{u_0^{n+1}} \\
	P_0^{n+1} &= P_{ext} + \beta \left( \sqrt{\frac{A_0^{n+1}}{A_{0,0}}} - 1 \right). 
\end{align}
where $P_{ext}$ is user defined and $A_{0,0}$ is the reference cross-section at the start point $i=0$ of the vessel.
If P is given the Riemann invariants at the next time step are computed via the following update formula:

\begin{align}
	W_{1,0}^{n+1} &= W^n_{1,0} + (W^n_{1,1} - W^n_{1,0})(c^n_0-u^n_0) \frac{\Delta t}{\Delta x} \label{update1b}\\
	W_{2,0}^{n+1} &= \frac{2Q^{n}_0}{A^n_0} - W^{n+1}_{1,0} \label{update2b}.
\end{align}

The missing input quantities are then computed from the new Riemann invariants as follows:

\begin{align}
	u_0^{n+1} &= \frac{W_{1,0}^{n+1} + W_{2,0}^{n+1}}{2} \\
	c_0^{n+1} &= \frac{W_{2,0}^{n+1} - W_{1,0}^{n+1}}{4} \\
	A_0^{n+1} &= A_{0,0}\left(\frac{P_0^{n+1}-P_{ext}}{\beta}\right)^2\\
	Q_0^{n+1} &= A_0^{n+1} u_0^{n+1}
\end{align}
where $P^{n+1}_0$ is given through input data.
\subsubsection{Outlets}

Reflection

In the general case this is done equivalently to the inlet boundary conditions through extrapolation of characteristics:
\begin{equation}
	\left\{\begin{array}{l}
			W_{2,M}^{n+1}=W_{2,M}^n+(W_{2,M-1}^n-W_{2,M-1}^n) (u_M^n+c_M^n) \frac{\Delta t}{\Delta x}, \\
			W_{1,M}^{n+1}=W_{1,M}^0-R_t (W_{2,M}^{n+1}-W_{2,M}^0),
	\end{array}\right.
\end{equation}
where $R_t \in [-1,1]$ is the reflection coefficient.

Windkessel

In the case of downstream vessels a three element Windkessel model is applied to simulate the perfusion as described in \cite{CiCP-4-317}.
Such models are referred to as lumped-parameter or 0D models due to the spatial dependency being integrated out.
\begin{comment}
	At capillary level, the pressure is assumed to be zero, i.e. $P_{\text {out }}=0$ and the coupling is performed by assuming that an intermediate state $\left(A^*, u^*\right)$ generates from $\left(A_l, u_l\right)$
	45
	D outlet) and $\left(A_r, u_r\right)$ (0D inlet) (Alastruey et al., 2008).
\end{comment}
In order to compute the output value through the Windkessel model we introduce an intermediate state $A^*$, $u^*$ that generates from the values at the end of the vessel $A_M$, $u_M$.
This state must satisfies a linearized version of the equations describing the blood flow that is computed by integrating out the spatial component
\begin{comment}
	\begin{equation}
		A^* u^*\left(1+\frac{R_1}{R_2}\right)+C_c R_1 \frac{\partial\left(A^* u^*\right)}{\partial t}=\frac{P_e-P_{\text {out }}}{R_2}+C_c \frac{\partial P_e}{\partial t}, \label{wk_eq1}
	\end{equation}
	where $P_c$ is initialised to zero and, at each time step, computed as
	\begin{equation}
		C_c \frac{\partial P_c}{\partial t}=A^* u^*-\frac{P_c-P_{\text {out }}}{R_2}. \label{wk_eq2}
	\end{equation}
	We consider $\beta$ and $A_0$ to be the same on both sides of the $0 \mathrm{D} / 1 \mathrm{D}$ interface. This yields the non-linear equation
	\begin{equation}
		f\left(A^*\right)=A^* R_1\left(u_l+4 c_l\right)-4 A^* R_1 c^*-\frac{\beta}{A_0}\left(\sqrt{A^*}-\sqrt{A_0}\right)+P_c \label{wk_eq3}
	\end{equation}
	where $c_l$ and $c^*$ are the wave speeds calculated with $A_l$ and $A^*$ respectively. $A^*$ is inilised to $A_l$ and $f\left(A^*\right)=0$ is solved iteratively by means of Newton's method. Once $A^*$ is found, $u^*$ reads
	\begin{equation}
		u^*=\frac{P_e^*-P_{o u t}}{A^* R_1}
	\end{equation}
	where $P_e^*=P_e\left(A^*\right)$.
	The corresponding code can be found in 

	src/boundary\_conditions.jl:169-216.
\end{comment}
\begin{equation}
	\left\{\begin{array}{l}
			\ C_c\frac{d P_{c}}{d t}+Q_{M}-A^*u^*=0,\\
			{L}{\frac{d Q_{out}}{d t}}+P_{M}-P_{c}=-R_2 Q_{M}\,.
	\end{array}\right.
\end{equation}
The following substitutions were introduced in order to be able to view the system analogously to an RCL-circuit
\begin{equation}
	L = \rho \frac{c}{A_0}, \  
	R_2 = \frac{\rho K_\nu}{A_0^2}, \ 
	C_c =\frac{2A_0}{\beta\sqrt{\pi}}. 
\end{equation}

Introducing a finite difference for the derivatives in both of these equations leads to
\begin{align}
	C_c{\frac{(P_{c})^{n}-(P_{c})^{n-1}}{\Delta t}} &+ (Q_M)^{n}-A^{*}U^{*} = 0, \label{lin_disc1}\\ 
	L\frac{(Q_M)^{n}-(Q_M)^{n-1}}{\Delta t} &+ R_{2}(Q_M)^{n}+P_M-(P_{c})^{n} = 0. \label{lin_disc2}
\end{align}

Using \ref{lin_disc2} to eliminate any occurrence of $Q_M^n$ \ref{lin_disc1} we get
\begin{align}
	(P_c)^n = \left(R_2 + \frac{L}{\Delta t}\right) \left( - C_c \frac{(P_c)^n - (P_c)^{n-1}}{\Delta t} + A^*u^*\right)+ P_M - \frac{L}{\Delta t} (Q_M)^{n-1}
\end{align}
and then solving for $(P_c)^n$ gives
\begin{multline}
	\left( 1+ \frac{C_c}{\Delta t}\left( R_2 + \frac{L}{\Delta t} \right) \right) (P_c)^n = \\
	\left( R_2 + \frac{L}{\Delta t} \right) \left( \frac{C_c}{\Delta t} (P_c)^{n-1} + A^*u^* \right) + P_M - \frac{L}{\Delta t} (Q_M)^{n-1}.
\end{multline}

Simplifying the equation and regrouping the terms gives
\begin{equation}
	\phi(P_{c})^{n}=R_2 \left( \frac{C}{\Delta t}(P_{c})^{n-1} + A^{*}U^{*}+\frac{1}{L+R_{2}\Delta t}\left(\Delta t P_M-L(Q_M)^{n-1}\right) \right),
\end{equation}
with 
\begin{equation}
	\phi{\cal=}\frac{R_{2}C}{\Delta t}{\bf+}\frac{R_{2}\Delta t}{L{+}R_{2}\Delta t}. \label{RCL}
\end{equation}

This gives us an update formula through which we can compute new values of $P_C$ at each step.
Since the inertia effect is negligible in the capillary bed we can set $L=0$ changing the update function for $P_C$ to 
\begin{equation}
	\phi(P_{C})^{n}=\frac{R_{2}C}{\Delta t}(P_{C})^{n-1}+R_{2}A^{*}U^{*}+P_{out},
\end{equation}
with 
\begin{equation}
	\phi{\cal=}\frac{R_{2}C}{\Delta t} + 1. 
\end{equation}

Introducing the relation
\begin{equation}
	A^{*}U^{*}={\frac{P_e(A^{*})-(P_{\mathrm{C}})^{n}}{R_{1}}} \label{RCLR}
\end{equation}
turns our RCL-circuit into an RCLR-circuit.
$P_e(A^*)$ denotes the pressure at the 1D/0D interface which is given through the tube law
\begin{equation}
	P_{e}(A^*)={\frac{\beta}{A_{0}}}\left({\sqrt{A^{*}}}-{\sqrt{A_{0}}}\right).
\end{equation}

Introducing the extra resistance prevents non-physical reflection of incoming waves.
We can rewrite \ref{RCLR} as 
\begin{equation}
	A^{*}U^{*}={\frac{P_e(A^{*})-(P_{M})_{R C L R}}{R_{1}+{\frac{R_{2}}{\phi}}}}, 
\end{equation}
with 
\begin{equation}
	\bigl(P_{M}\bigr)_{RCLR}=\bigl(P_{C}\bigr)^{n}-{\frac{R_{2}}{\phi}}A^{\ast}U^{\ast}.
\end{equation}
Inserting the tube law and requiring the outgoing characteristic at the end of the vessel $W_{2,M}$ to be equal to the incoming characteristic of our intermediate state $W_2^*$ we can derive a function whose roots correspond to the correct value for $A^*$
\begin{multline}
	f(A^{*}) = \left(R_{1}+{\frac{R_{2}}{\phi}}\right)\left( \left(u_{M}+4c_{M} \right)A^{*}-4c^*A^{*} \right) \\
	-{\frac{\beta}{A_{0}}}\Big(\sqrt{A^{*}}-\sqrt{A_{0}}\Big)+(P_{M})_{R C L R} =0. \label{wk_newton}
\end{multline}

Finally we can simplify \ref{wk_newton} by writing out $(P_{M})_{RCLR}$ and once more using that the outgoing Riemann invariant at the end of the vessel is equal to the incoming one of our intermediate state giving us
\begin{equation}
	f\left(A^*\right)=A^* R_1\left(u_M+4 c_M\right)-4 A^* R_1 c^*-\frac{\beta}{A_0}\left(\sqrt{A^*}-\sqrt{A_0}\right)+P_c = 0. \label{wk_eq3}
\end{equation}


\subsection{Junctions}
Three types of junctions are considered.
Conjunctions: joining two vessels, bifurcations: splitting one vessel into two, and anastomosis: joining two vessels into one.
\subsubsection{Conjunctions}
For all types of junctions three types of equations are taken into account. 
Extrapolation of characteristics, conservation of mass and total pressure conservation.
For the conjunctions this leads to
$$
W_1^*=u_1+4 c_1
$$
and 
$$
W_2^*=u_2-4 c_2
$$
where $W_{1,2}^*$ denote extrapolated characteristics. 
The extrapolation can either be done linearly, as it was done when setting boundary conditions, or constantly as it seems to be done in the code. 
The conservation of mass gives
$$A_1 u_1-A_2 u_2=0,$$
and for the conservation of total pressure
$$P_{t_1}=P_{t_2}.$$

This leads to the system of equations:
$$
\mathbf{f}_c=\left\{f_{c_i}\right\}=\left\{\begin{array}{l}
		q_{c_1}+4 k_1 q_{c_3}-W_1^*=0 \\
		q_{c_2}-4 k_2 q_{c_4}-W_2^*=0 \\
		q_{c_1} q_{c_3}^4-q_{c_2} q_{c_4}^4=0 \\
		\beta_1\left(\frac{q_{c_3}^2}{A_{01}^{1 / 2}}-1\right)+\frac{1}{2} \rho q_{c_1}^2-\beta_2\left(\frac{q_{c_4}^2}{A_{02}^{1 / 2}}-1\right)-\frac{1}{2} \rho q_{c_2}^2=0
\end{array}\right.
$$
where we have introduced the following notation in order to more easily write this system in a matrix-vector form
$$
\begin{aligned}
	\mathbf{q}_c&=\left\{q_{c_i}\right\}=\left[\begin{array}{llll}
		u_1, & u_2, & A_1^{1 / 4}, & A_2^{1 / 4}
\end{array}\right]^T,\  i=1, \ldots, 4. 
\end{aligned}
$$

The following shorthand notations have been introduced as well $c_i=k_i A_i^{1 / 4},$  $k_i=\sqrt{\frac{3}{2} \gamma_i}$.
The system is solved iteratively using the Newton method

$$
\left\{\begin{array}{l}
		\mathbf{J}_c \cdot \delta \mathbf{q}_c^n=-\mathbf{f}_c\left(\mathbf{q}_c^n\right) \\
		\mathbf{q}_c^{n+1}=\mathbf{q}_c^n+\delta \mathbf{q}_c^n
\end{array}\right.
$$

Where $\mathbf{J}_c$ is the Jacobian
$$\mathbf{J}_{c}=\left[\begin{array}{c c c c}{{{1}}}&{{0}}&{{{4}k_{1}}}&{{0}}\\ {{0}}&{{{1}}}&{{0}}&{{-4k_{2}}}\\ {{q_{c3}^{4}}}&{{-q_{c4}^{4}}}&{{4q_{c3}q_{3}^{3}}}&{{-4q_{c4}q_{c}^{3}}}\\ {{q_{c1}^{4}}}&{{-\rho q_{c2}}}&{{2\beta_{1}\frac{q_{c}}{A_{01}^{1/2}}}}&{{-2\beta_{2}\frac{q_{4}}{A_{02}^{42}}}}\end{array}\right].$$

The Jacobian depends on $\mathbf{q}_c^n$ and would have to be updated at every iteration of the Newton method but in this code a modified Newton method also known as frozen Newton is applied wherein the Jacobian is initialized with the initial value of $\mathbf{q}_c$ and then not updated anymore throughout further computations.
\subsubsection{Bifurcations}
For bifurcations the same conservation laws are applied.
This lead to the following system of equations:
$$
\mathbf{f}_c=\left\{f_{c_i}\right\}=\left\{\begin{array}{l}
		q_{c_1}+4 k_1 q_{c_4}-W_1^*=0 \\
		q_{c_2}-4 k_2 q_{c_5}-W_2^*=0 \\
		q_{c_3}-4 k_2 q_{c_6}-W_3^*=0 \\
		q_{c_1} q_{c_4}^4-q_{c_2} q_{c_5}^4-q_{c_3} q_{c_6}^4=0 \\
		\beta_1\left(\frac{q_{c_4}^2}{A_{01}^{1 / 2}}-1\right)-\beta_2\left(\frac{q_{c_5}^2}{A_{02}^{1 / 2}}-1\right)=0 \\
		\beta_1\left(\frac{q_{c_4}^2}{A_{01}^{1 / 2}}-1\right)-\beta_3\left(\frac{q_{c_6}^2}{A_{03}^{1 / 2}}-1\right)=0 
\end{array}\right. \label{syseq_bif}
$$
with the same shorthand notation as used when describing the Conjunctions and the following vector of variables
$$
\begin{aligned}
 \mathbf{q}_c=\left\{q_{c_i}\right\}=\left[\begin{array}{llllll}
		u_1, & u_2, & u_3, & A_1^{1 / 4}, & A_2^{1 / 4}, & A_3^{1 / 4}
\end{array}\right], \ i=1, \ldots, 6. 
\end{aligned}
$$

Once again the frozen Newton method is applied to solve the system.
The Jacobian here reads as
$$\mathbf{J}_{c}=\left[\begin{array}{c c c c c c}
		1&0&0&4k_1&0&0\\
		0&1&0&0&-4k_2&0\\
		0&0&1&0&0&-4k_3\\
		q_{c_4}^4 & -q_{c_5}^4 & -q_{c_6}^4 & 4q_{c_1}q_{c_4}^3 & -4q_{c_2}q_{c_5}^3 & -4q_{c_3}q_{c_6}^3 \\
		0 & 0 & 0 & 2\beta_1\frac{q_{c_4}}{A_{01}^{\frac{1}{2}}} & -2\beta_2\frac{q_{c_5}}{A_{02}^{\frac{1}{2}}} & 0\\
		0 & 0 & 0 & 2\beta_1\frac{q_{c_4}}{A_{01}^{\frac{1}{2}}} & -2\beta_3\frac{q_{c_6}}{A_{03}^{\frac{1}{2}}} & 0\\
	\end{array} 
\right].
$$

In \ref{syseq_bif} the kinetic energy terms $\frac{1}{2} \rho u^2$ are neglected.
	According to \cite{Formaggia2003OnedimensionalMF} this can be done since it's contribution to total pressure is small compared to the other terms.
\subsubsection{Anastomosis}
For the Anastomosis applying the extrapolation of characteristics, conservation of mass, and pressure conservation leads to the system of equations
$$
\mathbf{f}_c=\left\{f_{c_i}\right\}=\left\{\begin{array}{l}
		q_{c_1}+4 k_1 q_{c_4}-W_1^*=0 \\
		q_{c_2}+4 k_2 q_{c_5}-W_2^*=0 \\
		q_{c_3}-4 k_2 q_{c_6}-W_3^*=0 \\
		q_{c_1} q_{c_4}^4+q_{c_2} q_{c_5}^4-q_{c_3} q_{c_6}^4=0 \\
		\beta_1\left(\frac{q_{c_4}^2}{A_{01}^{1 / 2}}-1\right)-\beta_3\left(\frac{q_{c_6}^2}{A_{03}^{1 / 2}}-1\right)=0 \\
		\beta_2\left(\frac{q_{c_5}^2}{A_{02}^{1 / 2}}-1\right)-\beta_3\left(\frac{q_{c_6}^2}{A_{03}^{1 / 2}}-1\right)=0
\end{array}\right.
$$

With the same vector of variables as for the Bifurcations.
The Jacobian used when solving the system with the frozen Newton method here is
$$\mathbf{J}_{c}=\left[\begin{array}{c c c c c c}
		1&0&0&4k_1&0&0\\
		0&1&0&0&4k_2&0\\
		0&0&1&0&0&-4k_3\\
		q_{c_4}^4 & q_{c_5}^4 & -q_{c_6}^4 & 4q_{c_1}q_{c_4}^3 & 4q_{c_2}q_{c_5}^3 & -4q_{c_3}q_{c_6}^3 \\
		0 & 0 & 0 & 2\beta_1\frac{q_{c_4}}{A_{01}^{\frac{1}{2}}} & 0 & -2\beta_3\frac{q_{c_6}}{A_{03}^{\frac{1}{2}}} \\
		0 & 0 & 0 & 0 & 2\beta_2\frac{q_{c_5}}{A_{02}^{\frac{1}{2}}} &  -2\beta_3\frac{q_{c_6}}{A_{03}^{\frac{1}{2}}} \\
	\end{array} 
\right].
$$

As in the case of Bifurcations the kinetic energy terms in the pressure conservation equations are neglected.

\section{CFL Condition} \label{CFL}

The CFL condition is set so that the information traveling along a characteristic curve is only affect neighboring cells. 
Since the numerical scheme only takes neighboring cells into account doing otherwise would result in numerical error stacking up.
Usually $\Delta x$ is given by the user leaving $\Delta t$ to be determined.
Taking into account the aforementioned condition of preventing the characteristic curves from reaching beyond the neighboring cell within $\Delta t$ leads to the following equation:
\begin{equation}
	\Delta t \leq C_{CFL} \frac{\Delta x}{S_{max}},\hspace{10pt}  C_{CFL} \in (0,1).
\end{equation}
where $S_{max} = \max_{x \in [0,L], v \in V} | u_v(x) + c_v(x) |$ and V is the set of all vessels in the simulation.  
For Melis' thesis the value $0.9$ was chosen for $C_{CFL}$ since this offered a good compromise between numerical stability and computational time.
The corresponding code can be found in \texttt{src/solver.jl:57-69}.



\chapter{Numerical Methods}
The numerical realization of the 1D-Model within a single vessel described in \autoref{sec:sv} is achieved using a Finite Volume (FV) method to solve the homogenous part of the equation \autoref{eq:1deqs3} while the source term is accounted for by using a forward-euler timestep. 
The FV method that was applied here is the monotonic upstream-centered scheme for conservation laws (MUSCL).
A newton solver is applied to solve the linear systems of equations arrising from the junctions or the Windkessel model for outlets.
In this chapter we will first Introduce the MUSCL scheme and the Gudonov average applied within this scheme.
We will then apply the MUSCL scheme to the homogenous part of \autoref{eq:1deqs3}.
Finally we describe the forward-euler timestep used to accomodate the inhomogenous part as well as the newton solver for the outlets and junctions.

\section{MUSCL}
\section{Gudonov's}
\section{Time step, homogeneous part}
Next the following system of differential equations has to be solved for $(A,Au)$ within every vessel:

\begin{equation}
	\left\{\begin{array}{l}\frac{\partial A}{\partial t} + \frac{\partial(Au)}{\partial z} = 0,\\
	\frac{\partial (Au)}{\partial t} + \frac{\partial (Au^2)}{\partial z} + \frac{A}{\rho} \frac{\partial P}{\partial z} = -2 \frac{\mu}{\rho}(\gamma_\nu + 2)u \end{array} \right.
\end{equation}

This system stems from applying conservation laws as demonstrated in \cite{book}.
It can be reformulated in to a conservative form (with source term) as follows:

\begin{equation}
	\left\{\begin{array}{l}
			\frac{\partial \mathbf{U}}{\partial t}+\frac{\partial \mathbf{F}(\mathbf{U})}{\partial z}=\mathbf{S}(\mathbf{U}), \quad z \in[0, \ell], \\
			\mathbf{U}(z, 0)=\mathbf{U}^{(0)}(z), \quad t>0, \\
			\mathbf{U}(\mathbf{0}, t)=\mathbf{U}_L(t), \quad \mathbf{U}(\ell, t)=\mathbf{U}_R(t),
	\end{array}\right.
\end{equation}
where the necessary boundary conditions have been added.
In order to get the conservative formulation the following substitutions have been applied:

\begin{equation}
	\mathbf{U}=\left\{\begin{array}{c}
			A \\
			A u
	\end{array}\right\}, \\
\end{equation}

\begin{equation}
	\mathbf{F}(\mathbf{U})=\left\{\begin{array}{c}
			A u \\
			A u^2+\gamma A^{3 / 2}
	\end{array}\right\}
\end{equation}

\begin{equation}
	\mathbf{S}(\mathbf{U})=\left\{\begin{array}{c}
			0 \\

			f_s
	\end{array}\right\}, \\
\end{equation}
where the vectors $\mathbf{F}(\mathbf{U})$ and $\mathbf{U}$ are called the flux and the source term respectively.
Further substitutions and simplifications that have been done to get to the conservative formulation are as follows:

\begin{equation}
	\gamma=\frac{\beta}{3 \rho \sqrt{A_0}}, \\
\end{equation}

\begin{equation}
	f_s=-\frac{1}{\rho}\left[\frac{\partial P}{\partial A_0} \frac{\partial A_0}{\partial z}+\frac{\partial P}{\partial \beta} \frac{\partial \beta}{\partial z}+2 \mu\left(\gamma_\nu+2\right) \frac{u}{A}\right]
\end{equation}
\begin{equation}
	\begin{aligned}
		\tau & =\beta \sqrt{A_0}, \quad P=P_{e x t}+\tau\left(\sqrt{A}-\sqrt{A_0}\right),
	\end{aligned}
\end{equation}
\begin{equation}
	\frac{\partial P}{\partial A_0}=-\frac{\beta}{2}, \quad \frac{\partial P}{\partial \tau}=\sqrt{A}-\sqrt{A_0}.
\end{equation}
\begin{comment}
	The flux Jacobian reads
	\begin{equation}
		\frac{\partial \mathbf{F}}{\partial \mathbf{U}}=\mathbf{H}=\left[\begin{array}{cc}
				0 & 1 \\
				\frac{3}{2} \chi \sqrt{A}-u^2 & 2 u
		\end{array}\right],
	\end{equation}
	which, under the assumption $A>0$, has two eigenvalues
	\begin{equation}
		\lambda_{1,2}=u \mp c, \quad c=\sqrt{\frac{3}{2} \gamma \sqrt{A}}=\sqrt{\frac{\beta}{2 \rho}} A^{1 / 4}
	\end{equation}
\end{comment}

The conservative form is solved numerically in two steps. 
The first step solves the homogeneous part:
\begin{equation}
	\left\{\begin{array}{l}
			\frac{\partial \mathbf{U}}{\partial t}+\frac{\partial \mathbf{F}(\mathbf{U})}{\partial x}=0 \\
			\mathbf{U}\left(x, t^n\right)=\mathbf{U}^n
	\end{array} \quad \rightarrow \overline{\mathbf{U}}^{n+1},\right.
\end{equation}

This is done using Godunov's and the MUSCL scheme resulting in the following update step:

\begin{equation}
	\left\{\begin{array}{l}
			U_i^*=U_i^n+\frac{\Delta t}{\Delta x}\left(F_{i-1 / 2}^n-F_{i+1 / 2}^n\right), \\
			\overline{U}_i^{n+1}=\frac{1}{2} U_i^n+\frac{1}{2}\left[U_i^*+\frac{\Delta t}{\Delta x}\left(F_{i-1 / 2}^*-F_{i+1 / 2}^*\right)\right] .  \\
	\end{array} \right.
\end{equation}
\begin{comment}
	\begin{equation}
		U_i^n \underset{\Delta x \rightarrow 0}{=} \frac{1}{\Delta x} \int_{x_i-\frac{\Delta x}{2}}^{x_i+\frac{\Delta x}{2}} q\left(x, t_n\right) d x
	\end{equation}
\end{comment}

The flux used here is the widely used numerical flux Lax-Friedrichs:
\begin{equation}
	F_{i+1 / 2}^n=\frac{1}{2}\left(F_L^n+F_R^n\right)-\frac{\Delta x}{\Delta t}\left(U_{i+1}^n-U_i^n\right) .
\end{equation}

The values for the flux $F_L^n$ and $F_R^n$ are computed using a linear piece wise reconstruction (MUSCL).
In order to avoid too steep slopes that may lead to unrealistic values for the solution the superbee limiter is applied.


\section{Time step, source term}
Next the inhomogeneous part has to be solved:

\begin{equation}
	\left\{\begin{array}{l}
			\frac{d \mathbf{U}}{d t}=\mathbf{S}(\mathbf{U}), \\
			\overline{\mathbf{U}}^{n+1}
	\end{array} \quad \rightarrow \quad \mathbf{U}^{n+1},\right.
\end{equation}

This is done using the forward Euler method

\begin{equation}
	\mathbf{U}^{n+1}=\mathbf{U}^n + \Delta t \mathbf{S}\left(t^n, \mathbf{U}^n\right)
\end{equation}

In newer versions of the code a visco-elastic constitutive equation is solved as described in \cite{ALASTRUEY20112250}.
This is more accurate than the linear-elastic formulation described here.
The corresponding code can be found in 

\section{Newton Solver}

\chapter{Implementation}
Since differentiability was a priority in the implementation of this model the library JAX which is written is available as a package in python was used.
In order to leverage the full effectiveness of JAX some special considerations had to be made when considering the code structure.
In this chapter we will give an overview of the functionality of JAX in the first section and in the second section we will describe the code structure of the simulation.

\section{JAX}
\section{Code Structure}
\begin{lstlisting}[language=Python, caption=code structure in pseudocode]
converged = False
simulation_data = set_initial_conditions()
while not conv:
	simulation_data_new = set_boundary_conditions(simulation_data)
	simulation_data_new = muscl_solver(simulation_data_new)
	converged = chech_convergence(simulation_data, simulation_data_new)
	simulation_data = simulation_data_new
\end{lstlisting}
\chapter{Sensitivity Analysis}
\chapter{Conclusion/ Future Work}


% This displays the bibliography for all cited external documents. All references have to be defined in the file references.bib and can then be cited from within this document.
\bibliographystyle{IEEEtran}
\bibliography{references/references}

% This creates an appendix chapter, comment if not needed.
\appendix
\chapter{Code Documentation/ Manual} 


\end{document}

